# scripts/sync_erp_products.py

import os
import sys
import requests
from sqlalchemy import text
from app import create_app, db
from app.models import Product

app = create_app()

ERP_URL = "https://615f5fb4f7254d0017068109.mockapi.io/api/v1/products"

def sync_products_from_erp():
    with app.app_context():
        try:
            response = requests.get(ERP_URL, timeout=5)
            response.raise_for_status()
            erp_products = response.json()
        except Exception as e:
            print(f"❌ Erreur lors de l’appel à l’ERP mock : {e}")
            return

        # Supprime les anciens produits
        try:
            db.session.execute(text("TRUNCATE TABLE product RESTART IDENTITY CASCADE;"))
            db.session.commit()
        except:
            db.session.execute(text("DELETE FROM product;"))
            db.session.commit()

        # Insère les nouveaux produits depuis ERP mock
        produits = []
        for item in erp_products:
            details = item.get("details", {})
            produit = Product(
                name=item.get("name", "Produit sans nom"),
                description=details.get("description", ""),
                price=float(details.get("price", 0)),
                model_url=""  # à remplir plus tard si besoin
            )
            produits.append(produit)

        db.session.add_all(produits)
        db.session.commit()
        print(f"✅ {len(produits)} produits synchronisés depuis l’ERP.")

if __name__ == "__main__":
    sys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))
    sync_products_from_erp()
